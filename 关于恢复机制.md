### 关于恢复机制
本项目的恢复机制参考《数据库系统概念（第六版）》第16章 恢复系统。

#### 前言
系统可能发生的故障有很多种，本项目中只考虑如下类型的故障：
1. 事务故障：逻辑错误或者系统错误导致事务处理停止
2. 系统崩溃：硬件故障，或者操作系统or存储系统本身的漏洞导致易失性存储器内容丢失，而非易失性存储器任然完好无损
3. 硬盘故障：由于磁头损坏或者故障造成磁盘上内容的丢失。

### 存储器
存储介质可以通过它们的相对速度、容量、故障弹性区分为一下几种类型：
1. 易失性存储器：系统崩溃后存储的信息不会保留，例如：内存。
2. 非易失性存储器：系统崩溃后存储信息保留，但是受到故障影响会导致信息丢失。例如：磁盘、磁带、闪存等。
3. 稳定性存储器：存储的信息永远不丢失，一般由备份技术+独立故障模式等技术在非易失性存储器上实现。

事务的持久性需要将修改操作写入稳定性存储器来保证。（关于这一点，其实可以将稳定性存储器看做一种前提或者约束，事务的持久性建立在修改日志不丢失并且没有损坏的前提下，为了便于叙述，我们将这种约束或者前提用稳定性存储器来概括）

#### 事务
无论是存储系统的使用者，还是存储系统内部一些变更操作，都需要这样的功能：多个修改操作要么都生效，要么都不能生效，即使在修改过程中发生了上述故障，机器or进程重启后通过恢复机制仍然要满足这个条件，我们把这些修改操作称为一个事务，而上述的功能体现了事务的原子性和持久性。这就是恢复系统需要完成的工作，本项目通过更新日志记录来实现恢复系统。

更新日志记录有如下几个字段：
* 事务标识
* 数据项标识
* 旧值
* 新值

一个事务的修改操作记录在多条更新日志记录中，并且有些日志记录专门用来记录事务的开始、提交或者中止（我们分别表示为T start、T commit 和T abort）。
事务开始时首先向稳定存储器写入事务开始日志，事务在进行每个修改操作时，首先生成对应的更新日志记录并写入稳定存储器，当所有修改操作完成后，写入事务结束日志。
事务结束日志写入稳定存储器之后即标志事务提交。

在故障发生时，任何一个事务的修改操作可分为以下几种类型：
1. 还没开始，写入事务开始日志前故障发生
2. 进行中，写入事务开始日志，并进行了部分修改并写入部分更新日志记录
3. 提交，已经写入了事务结束日志

在恢复系统中，对于类型1事务不需要做任何操作。对于类型2的事务，按照更新日志记录写入顺序的逆序用旧值覆盖掉修改操作（undo操作）。对于类型3的事务，按照提交顺序用新值重新执行修改操作（redo操作）。（因为修改操作可能仅记录在内存中，还没刷盘）这保证了事务的修改要么全部生效，要么全部不生效。

注意点：
* redo和undo操作必须是幂等的，因为有可能恢复过程中系统又崩溃了，再次进行恢复，导致redo or undo操作执行多于一次；已经提交的事务的修改可能刷盘了也可能没刷盘，也会导致redo执行多于一次。
* 更新日志记录需要写入稳定性存储器，但是只有磁盘的情况下如何尽量确保日志数据不丢不错？每条日志记录本身使用crc32等校验算法进行校验，防止日志部分写入系统崩溃，读到错误的日志。
* 由于redo和undo操作是幂等的，因此可以简化恢复算法，首先对所有更新日志记录执行redo操作，在遍历日志过程中记录没有提交的日志，然后按照逆序执行undo操作，这样只需要顺序遍历一遍日志。而且redo（undo）执行的顺序是非常重要的，必须按照修改时的顺序（逆序）执行，否则涉及同一块数据的修改操作如果乱了顺序，会导致错误。
* 随着修改操作不断进行，更新日志记录会不断累积，如果每次重启都从最初始状态开始，则很快恢复阶段会消耗大量的时间，日志占据的磁盘容量也过于庞大，因此需要引入check point机制：周期性的将系统中所有被修改且暂存于内存中的数据写入磁盘，同时更新日志记录也写入磁盘，然后在日志中插入一条check point日志，这条日志标志着：之前的所有更新日志记录涉及的修改都已经同步到磁盘，不需要再执行了，因此之前的日志占据的空间都可以释放，并且恢复系统只需要从最后一条check point日志开始恢复即可。
* 在引入check point机制后，带来了另一个问题：大部分存储系统将磁盘空间划分为block进行管理，如果在写入磁盘时发生了partial write，导致某个block的数据部分是新的部分是旧的，这种问题是没有办法仅通过更新日志记录来恢复的，因此需要通过校验机制+ double write技术使得每个block一定处于某个一致的状态。

#### 本项目目前的实现情况
实现了：
* 基于crc32的block校验机制
* 基于double write的block完整性保证
* 基于更新日志记录的恢复机制（还没有做checkpoint和日志缓冲区）